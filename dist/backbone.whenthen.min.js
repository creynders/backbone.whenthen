!function(t,e){"object"==typeof exports?module.exports=e(require("underscore")):"function"==typeof define&&define.amd?define(["underscore"],e):(t.WhenThen=e(t._),t.Backbone&&(t.Backbone.WhenThen=t.WhenThen))}(this,function(t){"use strict";function e(t){if(!(t&&t.on&&t.trigger&&t.off))throw new Error("subject must have `on`, `off` and `trigger` methods, compatible with Backbone.Events");return t}function n(t,e,n){this._root=t,this._puppet=e,this._original=n}return t.extend(n.prototype,{_original:void 0,_callbacks:[],_current:[],_root:void 0,_puppet:void 0,_unregistered:!0,_exec:function(e){t.each(this._callbacks,function(t){t.apply(null,e)}),this._reset()},_registerDependencies:function(){this._unregistered&&(this._reset(),this._unregistered=!1)},_reset:function(){t.each(this._original,function(e){this._puppet.once(e,function(){this._handle(e,t.toArray(arguments))},this)},this),this._current=t.clone(this._original)},_handle:function(t,e){this._current.splice(this._current.indexOf(t),1),this._current.length||this._exec(e)},_destroy:function(){this._puppet.off(null,null,this),this._current=void 0,this._original=void 0,this._callbacks=void 0,this.then=this.have=function(){throw new Error("`then` instance destroyed")}},have:function(n){e(n);var r=this;return{then:function(){var e=t.flatten(t.toArray(arguments));if(e.length<=0)throw new TypeError("`then` requires at least one string or function");this._registerDependencies();var r=1===this._original.length,i=t.map(e,function(e){var i,s,o;if(t.isString(e))i=n.trigger,s=n,o=e;else{if(!t.isFunction(e))throw new TypeError("`then` only accepts (arrays of) strings or functions");i=e,s=null}return r?function(){var e=t.toArray(arguments);o&&e.unshift(o),i.apply(s,e)}:function(){i.call(s)}});return this._callbacks=this._callbacks.concat(i),{when:this._root.when}}.bind(r)}},then:function(){return this.have(this._puppet).then.apply(this,t.toArray(arguments))}}),function(r){e(r);var i={_builders:[]};return i.when=function(){if(arguments.length<=0)throw new TypeError("`when` requires at least one string");var e=t.flatten(t.toArray(arguments));t.each(e,function(e){if(!t.isString(e))throw new TypeError("`when` only accepts (arrays of) strings")});var s=new n(i,r,e);return this._builders.push(s),s},i.destroy=function(){t.each(this._builders,function(t){t._destroy()}),this._builders=void 0,this.destroy=this.when=function(){throw new Error("`when` instance destroyed")}},i}});